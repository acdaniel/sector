/** sector v0.1.0 | (c) 2014 Adam Daniel <adam@acdaniel.com> | MIT license */
!function(t,i){if("function"==typeof define&&define.amd)define(["lodash","jquery","exports"],function(e,n,s){t.sector=i(t,s,e,n||t.jQuery||t.$)});else if("undefined"!=typeof exports){var e,n=require("lodash");try{e=require("jquery")}catch(s){}i(t,exports,n,e||t.jQuery||t.$)}else t.sector=i(t,{},t._,t.jQuery||t.$)}(this,function(t,i,e,n){i.$=n,i.utils={define:function(t){var n,s=[],o=this;if(n=t&&e.has(t,"constructor")?t.constructor:function(){return o.apply(this,arguments)},n.prototype=e.create(o.prototype,t),e.extend(n,o),e.bindAll(n),arguments.length>1){s=new Array(arguments.length-1);for(var r=1,h=s.length;h>=r;r++)s[r-1]=arguments[r]}return i.utils.mixin.call(n.prototype,s),n},mixin:function(t){t&&(this._mixins=e.has(this,"_mixins")?this._mixins:[],e.forEach(t,function(t){-1===this._mixins.indexOf(t)&&(t.call(this),this._mixins.push(t))},this))}},i.mixins={Hooked:function(){this.after=function(t,i){var e=this[t];this[t]=function(){e.apply(this,arguments),i.apply(this,arguments)}},this.before=function(t,i){var e=this[t];this[t]=function(){i.apply(this,arguments),e.apply(this,arguments)}},this.around=function(t,i){var n=this[t];this[t]=e.wrap(n,i)}},Traceable:function(){console&&(e.defaults(this.defaults,{debug:!1}),this.trace=function(t,i){this.debug&&console.log(this+" "+t,i)},this.after("initialize",function(t){this.trace("initialized",t)}),this.after("destroy",function(){this.trace("destroyed")}))},Listener:function(){this.listenTo=function(){var t,n,s,o,r=this,h=arguments.length,a=arguments[h-1];4===h?(t=arguments[0],n=arguments[1],s=arguments[2]):"object"==typeof arguments[0]?(t=arguments[0],n=arguments[1]):2===h?n=arguments[0]:(n=arguments[0],s=arguments[1]),!t||t instanceof i.$?t||(t=this.$el):t=this.$(t),n+="."+this.id,a=e.isString(a)?this[a]:a,o=t.data("sectorEvents")?t.data("sectorEvents"):[],t.data("sectorEvents",e.union(o,[n])),this._listeningTo=this._listeningTo?e.union(this._listeningTo,[t.selector]):[t.selector],t.on("DOMNodeRemoved."+this.id,function(e){r.stopListening(i.$(e.target)),t.off("DOMNodeRemoved."+this.id)}),this.trace&&this.trace("<+> "+t.get()+"."+n),t.on(n,s,e.bind(function(t){this.trace&&this.trace("<- "+t.target+"."+t.type),a.apply(this,arguments)},this))},this.stopListening=function(t,n,s){var o,r=arguments.length;2===r&&"object"!=typeof t&&(s=n,n=t,t=void 0),1===r&&"object"!=typeof t&&(n=t,t=void 0),!this.$||!t||t instanceof i.$?this.$&&!t&&(t=this.$el):t=this.$(t),n+="."+this.id,this.trace&&this.trace("<x> "+t.get()+"."+n),t.off(n,s),o=t.data("sectorEvents")||[],e.remove(o,function(t){return-1!==t.indexOf(n,t.length-n.length)}),t.data("sectorEvents",o),0===o.length?(t.data("sectorEvents",void 0),this._listeningTo&&e.remove(this._listeningTo,t.selector)):t.data("sectorEvents",o)},this.before("destroy",function(){var t,n=this,s="."+this.id;e.forEach(this._listeningTo,function(o){var r=i.$(o);r.off(s),t=r.data("sectorEvents")||[],e.remove(t,function(t){return-1!==t.indexOf(s,t.length-s.length)}),delete n._listeningTo,r.data("sectorEvents",t)})})},PubSub:function(){e.defaults(this.defaults,{trace:!1}),this.publish=function(t,e){this.trace&&this.trace("=>> "+t,e);var n=i.$(this.$el.get(0).ownerDocument||this.$el),s="pubsub."+t;n.trigger(s,[e,this.id])},this.subscribe=function(t,n){var s=this;n||(n=t,t=void 0),this.trace&&this.trace("<<+>> "+t);var o=i.$(this.$el.get(0).ownerDocument||this.$el),r="pubsub"+(t?"."+t:"");n=e.isString(n)?this[n]:n,this.listenTo(o,r,function(i,e,o){this.trace&&this.trace("<<= "+t,e),n.call(s,t,e,o)})},this.unsubscribe=function(t){this.trace&&this.trace("<<x>> "+t);var e=i.$(this.$el.get(0).ownerDocument||this.$el),n="pubsub."+t;this.stopListening(e,n)}}};var s=i.Registry=function(){this.components={},this.instances={},this.instancesAll={}};s.prototype.addComponent=function(t){var i=t.prototype.type;if(this.components[i])throw new Error("a component with type "+i+" is already defined");this.components[i]=t},s.prototype.addInstance=function(t){if(this.instancesAll[t.id])throw new Error("an instance with id "+t.id+" already exists");this.instancesAll[t.id]=t,this.instances[t.type]=this.instances[t.type]||{},this.instances[t.type][t.id]=t},s.prototype.findComponent=function(t){return this.components[t]||null},s.prototype.findInstance=function(t){return this.instancesAll[t]||null},s.prototype.findInstancesOf=function(t){var i=e.isString(t)?t:t.type;return e.values(this.instances[i])||null},s.prototype.removeComponent=function(t){var i=e.isString(t)?t:t.type;delete this.components[i]},s.prototype.removeInstance=function(t){var i=e.isString(t)?t:t.id;t=this.instancesAll[i],delete this.instancesAll[i],delete this.instances[t.type][i]},s.prototype.removeInstancesOf=function(t){var i=e.isString(t)?t:t.type,n=this.instances[i];for(var s in n)delete this.instancesAll[s];delete this.instances[i]},i.registry=new s;var o=i.Component=function(t){var n=e.omit(t,"el"),s=e.pick(t,"el"),o=e.result(this,"defaults"),r=e.pick(n,function(t,i){return e.has(o,i)||"id"===i});if(e.defaults(this,r,o),this.id||(this.id=e.uniqueId("i")),e.has(s,"el")){if("undefined"==typeof i.$)throw new Error("sector.$ not set to a valid jQuery instance");this.$el=i.$(s.el),this.$=e.bind(this.$el.find,this.$el),this.after("destroy",function(){delete this.$el,delete this.$})}i.registry.addInstance(this),this.initialize.call(this,n)};o.prototype.toString=function(){return"["+this.type+" "+this.id+"]"},o.prototype.defaults={},o.prototype.initialize=e.noop,o.prototype.destroy=e.noop,o.define=function(t){var n,s;return t.type||(t.type=e.uniqueId("c")),n=Array.prototype.slice.call(arguments,1),n.unshift(t,i.mixins.Hooked,i.mixins.Traceable,i.mixins.Listener,i.mixins.PubSub),s=i.utils.define.apply(this,n),i.registry.addComponent(s),s},o.attachTo=function(t,e,n){var s,o=this;if(e=e||{},n=!!n)e.el=t,s=new this(e);else{var o=this;i.$(t).each(function(){e.el=this,s=new o(e)})}},o.destroyAll=function(){for(var t=i.registry.findInstancesOf(this.prototype.type),e=0,n=t.length;n>e;e++)t[e].destroy(),i.registry.removeInstance(t[e])};i.mixins.View=function(){var t={};this.bindUI=function(){if(this.ui){this._ui||(this._ui=this.ui);var t=e.result(this,"_ui");this.ui={},e.forIn(t,function(t,i){this.ui[i]=this.$(t)},this)}},this.bindEvents=function(){this.events&&e.forIn(this.events,function(t,i){var e=i.split(".",2);this.stopListening(this.ui[e[0]],e[1]),this.listenTo(this.ui[e[0]],e[1],t)},this)},e.has(this,"render")||(this.render=function(n){var s="",o="";this.template&&(e.isFunction(this.template)?s=this.template(n):(e.has(t,this.template)?o=t[this.template]:(o=i.$(this.template).html(),t[this.template]=o),s=e.template(o,n)),this.$el.html(s))}),this.remove=function(){this.$el.remove(),this.destroy()},this.after("render",function(){this.bindUI(),this.bindEvents()}),this.before("initialize",function(){this.bindUI(),this.bindEvents()})};return i});